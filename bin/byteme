#!/usr/bin/env node
const ByteMan = require('../src/cli/ByteMan');
const WebSocket = require('ws');
const byteMan = new ByteMan();

const WS_PORT = 8080;
const wss = new WebSocket.Server({ port: WS_PORT });

wss.on('connection', (ws) => {
    ws.on('message', async (message) => {
        try {
            const data = JSON.parse(message);
            const result = await byteMan.execute(data.command, data.args);
            ws.send(JSON.stringify({ status: 'success', result }));
        } catch (error) {
            ws.send(JSON.stringify({ status: 'error', message: error.message }));
        }
    });
});

const args = process.argv.slice(2);
const command = args[0];

async function run() {
    try {
        if (!command || command === '--help' || command === '-h') {
            await byteMan.showHelp();
            return;
        }
        
        const result = await byteMan.execute(command, args.slice(1));
        wss.clients.forEach(client => {
            if (client.readyState === WebSocket.OPEN) {
                client.send(JSON.stringify({ status: 'update', result }));
            }
        });
    } catch (error) {
        console.error('‚ùå Error:', error.message);
        process.exit(1);
    }
}

run();